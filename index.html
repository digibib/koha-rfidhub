<!doctype html>

<html>
<head>
  <meta charset="utf-8">
  <title>Test</title>
  <style>
    body { background: #fff; color: #222; font-family: Arial; font-size: 14px;}
    table { width: 100%;}
    th { border-bottom: 1px solid #ccc; background: #eee; text-align: left; font-size:120%;}
    td { min-width: 150px; padding: 4px;}
    h2 { background: #ccc;}
    button { margin-right:1em;}
    li { margin-bottom:0.3em;}
    li:nth-child(odd) { background: #eee;}
    #content { width: 1000px; margin: auto;}
    #logg { font-family: monospace; list-style-type: none; padding:0; margin:0 ;}
    .active:before { color: green; font-size:30px; content: '• '; vertical-align: middle;}
    .hidden { display: none;}
  </style>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
</head>
  <div id="content">

  <h1>Test av RFID-kommunikasjon</h1>

  <h2>Tilkoblede RFID-enheter</h2>
  <table>
    <thead>
      <tr>
        <th>Addresse</th>
        <th>Interagér med enheten</th>
      </tr>
    </thead>
    <tbody>
      <tr class="unit hidden">
        <td class="active">10.172.2.233</td>
        <td>
          <button class="scan-start">Start scanning</button>
          <button class="scan-stop">Stop scanning</button>
          <button class="alarm-on">Aktivér alarm</button>
          <button class="alarm-off">Deaktivér alarm</button>
          <input class="bytestring" type="text" placeholder="bytestreng"/>
          <button class="write" disabled="true">Prege brikke</button>
        </td>
      </tr>
      {{range .Units}}
        <tr class="unit" id="unit-{{.}}">
          <td class="active">{{.}}</td>
          <td>
            <button class="scan-start">Start scanning</button>
            <button class="scan-stop">Stop scanning</button>
            <button class="alarm-on">Aktivér alarm</button>
            <button class="alarm-off">Deaktivér alarm</button>
            <input class="bytestring" type="text" placeholder="bytestreng"/>
            <button class="write" disabled="true">Prege brikke</button>
          </td>
        </tr>
      {{end}}
    </tbody>
  </table>

  <h2>Kommunikasjonslogg</h2>

  <ul id="logg">
    <li></li>
  </ul>

</div>

<body>
  <script>
  function log(line) {
    var logLine = new Date() + line;
     $('#logg').prepend('<li>'+logLine+'</li>');
  }

  $(document).ready(function() {
    var ws=new WebSocket('ws://{{.Host}}/ws');
    ws.onopen = function() {
      console.log("connected");

      ws.onmessage = function(resp) {
        var data = JSON.parse(resp.data);
        console.log(data);
        switch (data.Type) {
          case "CONNECT":
            var $tr = $('tr.hidden').clone().removeClass('hidden');
            $tr.attr('id', 'unit-'+data.ID);
            $tr.find('.active').html(data.ID);
            $('tbody').append($tr);
            log(" -- RFID-unit connected: "+data.ID);
            break;
          case "DISCONNECT":
            $(document.getElementById('unit-'+data.ID)).remove();
            log(" -- RFID-unit disconnected: "+data.ID);
            break;
        }
      };
    };
    ws.onclose = function() {
      console.log("disconected");
      // TODO try to reconnecd SetInterval 1 sec
    };

    $('table').on('keyup', '.bytestring', function() {
      if ( $(this).val().trim() !== "" ) {
        $(this).parents('td').find('.write').attr('disabled', false);
      } else {
        $(this).parents('td').find('.write').attr('disabled', true);
      }
    });

    $('table').on('click', '.scan-start', function() {
      var id = $(this).parents('tr').attr('id').substring(5);
      var msg = { ID: id, Msg: {cmd: "SCAN", data: "ON"} };
      ws.send(JSON.stringify(msg));
      log(' -> { "ID":"' + id.substring(5)+ '", "Msg": {"cmd": "SCAN", "data": "ON"} }'+"\n");
    });

    $('table').on('click', '.scan-stop', function() {
      var id = $(this).parents('tr').attr('id').substring(5);
      var msg = { ID: id, Msg: {cmd: "SCAN", data: "OFF"} };
      ws.send(JSON.stringify(msg));
      log(' -> { "ID":"' + id.substring(5)+ '", "Msg": {"cmd": "SCAN", "data": "OFF"} }'+"\n");
    });

        $('table').on('click', '.alarm-on', function() {
      var id = $(this).parents('tr').attr('id').substring(5);
      var msg = { ID: id, Msg: {cmd: "ALARM", data: "ON"} };
      ws.send(JSON.stringify(msg));
      log(' -> { "ID":"' + id.substring(5)+ '", "Msg": {"cmd": "ALARM", "data": "ON"} }'+"\n");
    });

    $('table').on('click', '.alarm-off', function() {
      var id = $(this).parents('tr').attr('id').substring(5);
      var msg = { ID: id, Msg: {cmd: "ALARM", data: "OFF"} };
      ws.send(JSON.stringify(msg));
      log(' -> { "ID":"' + id.substring(5)+ '", "Msg": {"cmd": "ALARM", "data": "OFF"} }'+"\n");
    });

    $('table').on('click', '.write', function() {
      var id = $(this).parents('tr').attr('id').substring(5);
      var writeString = $(this).parents('tr').find('.bytestring').val();
      var msg = { ID: id, Msg: {cmd: "WRITE", data: writeString} };
      ws.send(JSON.stringify(msg));
      log(' -> { "ID":"' + id.substring(5)+ '", "Msg": {"cmd": "WRITE", "data": "' + writeString +'"} }'+"\n");
    });

  });
  </script>
</body>
</html>